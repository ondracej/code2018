% code for the delay map of the dispersion of SWRs

%%%%%%%%%%%%%%%%%%%%%%%%%% The Recipe %%%%%%%%%%%%%%%%%%%%%%%%%%%

% We read SWRs (columns), one at a time, from variable SWRs. Within each
% SWR, we make the envelioe of the ripple burst using Hilbert transform. The 
% onset of the ripple wave is ditermined using a threshold crossing over the envelope.
% Therefore we will have the time-of-ocurrance of SWR at each channel. Then we center
% all these times relative to the first one, so all will be either zero or
% positive numbers. When we perform this procress for all detected SWRs, we
% interpolate this relative-delay-time matrix for more spatial point, to have 
% a better spacial resolution in the visualization and plot it
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% add the data folder to the current path

file_add='Z:\zoologie\JanieData\JanieSliceSWRDetections\1453-bic01'; %%%%%%%% the path for the detected SWRs
swr_count=12; %%%%%%%%%%% which detected SWR to process?

addpath(genpath(file_add));
pathparts = strsplit(file_add,'\'); data_name=pathparts{end};
addpath(genpath(file_add));
data=load('detections');
SWRs=data.D.AllSWRDataOnChans; % each column of this cell is one SWR, rows correspond to channels
addpath(genpath(file_add));
%% reorganizing the data in matrices and SWR trough detection

% designing a filter for extraction of low frequenc ı component of each
% SWR, the sharp wave (e.g. 20-40 Hz)
fs=32000; % sampling rate
[b1,a1] = butter(2,[150 400]/(fs/2)); % ripple burst spectral range
[b2,a2] = butter(2,[.2 20]/(fs/2)); % sharp wave range

% reading from the cell, filtering, and rearranging in a 3D matrix
swr_count_=swr_count;
    for chnl=1:size(SWRs,1)
        SWR(:,chnl)=SWRs{chnl,swr_count_};
    end
    
    % we filter the data to just extract the low-frequency component,
    % the Sharp Wave, and to detect the trough based on it
    ripple=filtfilt(b1,a1,SWR);
    sharp_wave=filtfilt(b2,a2,SWR);
    
    ripples_mat(:,:,swr_count_)=ripple;
    sharp_wave_mat(:,:,swr_count_)=sharp_wave;


%% plotting one SWR for all channels
dist=10; % distance between channels for the plottring %???????????????????
figure
for chnl=1:size(SWRs,1)
    subplot(1,2,1) % first subplot Sharp Wave
    plot((1:length(sharp_wave_mat(:,:,swr_count)))/fs,sharp_wave_mat(:,chnl,swr_count)-dist*chnl,...
        'color',[0 .4 .2]);
    hold on
    yticks(dist*(-chnl:4:-1));
    yticklabels(num2cell(1:4:chnl));
    xlim([.5 1.5])
    ylabel('channels')
    xlabel('Time (sec)');
    subplot(1,2,2) % second subplot Sharp wave and Ripples
    plot((1:length(ripples_mat(:,:,swr_count)))/fs,.5*ripples_mat(:,chnl,swr_count)-dist*chnl,...
        'color',[1 .5 .6]);
    plot((1:length(sharp_wave_mat(:,:,swr_count)))/fs,sharp_wave_mat(:,chnl,swr_count)-dist*chnl,...
        'color',[0 .4 .2]);
    hold on
    yticks(dist*(-chnl:4:-1));
    yticklabels({});
    xlim([.5 1.5])
    xlabel('Time (sec)');
    
end

%% extracting the ripple envelope, plotting 1 SWR along channels
% extracting the trough times across channels

for chnl=1:size(sharp_wave_mat,2)
    [~,t_trough_ind(chnl)]=min(sharp_wave_mat(:,chnl,swr_count),[],'all','linear');
end
t_trough=(t_trough_ind-min(t_trough_ind,[],'all'))/fs;

% ripple envelope and plot with sharp waves
win_len=round(fs/20) ; % sliding window for the RMS envelope
[up,lo] = envelope(ripples_mat(:,:,swr_count),win_len,'rms');

% plotting one SW and ripple envelopes for all channels
dist=20; % distance between channels for the plottring %???????????????????
samps=1:1:length(SWR);
t_plot=samps/(fs/1)-1;
figure
chnls=1:59; % channels to plot
for chnl=chnls %size(SWRs,1)
    sub1=subplot(1,2,2); % for the sharp wave and ripples envelope
    plot(t_plot,ripples_mat(samps,chnl,swr_count)+dist*chnl,'color',[1 .5 .6]);     hold on
    plot(t_plot,up(samps,chnl)+dist*chnl,t_plot,lo(samps,chnl)+dist*chnl,'color',[.5 0 0]); 
    yticks([]);
    xlim([-.5 .5])
    ylim(dist*[chnls(1)-1 chnls(end)+1])
    xlabel('Time (sec)');
    
    subplot(1,2,1) % for the sharp wave and the ripples
    plot(t_plot,ripples_mat(samps,chnl,swr_count)+dist*chnl,'color',[1 .5 .6]);     hold on
    plot(t_plot,sharp_wave_mat(samps,chnl,swr_count)+dist*chnl,'color',[0 .4 .2]);
    yticks(dist*(chnls(1):4:chnls(end)));
    yticklabels(num2cell(chnls(1):4:chnls(end)));
    ylabel('channels')
    xlim([-.5 .5])
    ylim(dist*[chnls(1)-1 chnls(end)+1])
    xlabel('Time (sec)');
    title(['SWRs,  Data name: ' data_name  ', Nr. ' num2str(swr_count) ]);
    
end

% threshold for ripple detection
tr=median(up)+3.0*iqr(up);
t0=ones(1,length(chnls));
subplot(1,2,2) % adding the threshold to the subplot 1
for chnl=chnls
    t_0=find(up(:,chnl)>tr(chnl),1); % time index of the first supra threshold detection
    if t_0>.7*fs & t_0<1.2*fs
    t0(chnl-chnls(1)+1)=t_0;  % fist supra-threshold sample for each channel
    end
    plot(t_plot(t0(chnl-chnls(1)+1)),up(t0(chnl-chnls(1)+1),chnl)+dist*chnl,'color',[.4 .0 .4],'marker','s','markersize',5);
    title('detection of ripple onset');
end
t00=t0/fs;
%% delay map visualization

% the time when the SWR has been detected in a channel first, is the reference time, or zero
% delay, and we consider the time of observation of the SWR in the other
% channels as the daly of the spread of the SWR, so we subtract the t_min
% from all the t_delays
sorted_t00=unique(sort(t00)); t00_min=sorted_t00(3); % after sorting the delay times, the first one is 0 (or 1/fs) which is associated ...
% with the channels with no detected SWR.
t0=t00-t00_min;
% constructing the grid of coordinates based on the paddings of our
% recording micro array electorde
% z matrix, regarding the fact that some of the entries in the 8x8 array
% are not active electrodes, we can assign any random value, i.e. random delay, to those places, just to be able to
% make a complete matrix. To keep the continuity, we assign a neighboring values to those entries.
% At the end we do not consider those places on the final plot
zz=[t0(5) t0(1:3) t0(3) t0(4:5) t0(5) t0(6:53) t0(54) t0(54:59) t0(59)];
z=reshape(zz,8,8);

figure0=figure;
max_val=max(z,[],'all');
min_val=min(z,[],'all');
clim=[0 .3]; % 
spacing=100; % spacing between electrode pads
cmap=flipud(summer);
imagesc([0 7*spacing],[0 7*spacing],z,clim); colormap(cmap); axis equal
% Create rectangle
annotation(figure0,'rectangle', [0.654 0.780 0.0704 0.097],'Color',[1 1 0.066],'FaceColor',[0.501 0.501 0.501]);
annotation(figure0,'rectangle',[0.6545 0.1571 0.07042 0.09761],'Color',[1 1 0.06666],'FaceColor',[0.501 0.501 0.501]);
annotation(figure0,'rectangle',[0.186 0.1595 0.0704 0.0976],'Color',[1 1 0.06666],'FaceColor',[0.5019607 0.5019607 0.50196]);
annotation(figure0,'rectangle', [0.186714 0.7809 0.07042 0.0976],'Color',[1 1 0.0666],'FaceColor',[0.50196 0.5019 0.501960]);
annotation(figure0,'rectangle',[0.18671 0.4261 0.070428 0.097],'Color',[1 1 0.0666],'FaceColor',[0.501960 0.50196 0.501960]);
colorbar

% smooting the matrix

% finding the RGB value associated with the matrix:
ncol = size(cmap,1);
col_ind = floor(1+(ncol-1)*zz/max_val);
rgb_image = ind2rgb(col_ind,cmap);

% interpolation
im=reshape(rgb_image,8,8,3);
F = griddedInterpolant(im);

[sx,sy,sz] = size(im);
xq = (0:1/30:sx)';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
yq = (0:1/30:sy)';
zq = (1:sz)';
F.Method = 'linear';

vq = (F({xq,yq,zq}));
figure1=figure;
imagesc([0 8*spacing],[0 8*spacing],vq,clim);axis equal
colormap(cmap);
title(['Data name: ' data_name ', Nr. ' num2str(swr_count) ', Delay map']);
xlabel('x (\mu m)','fontweight','bold')
ylabel('y (\mu m)','fontweight','bold')
a = colorbar;
a.Label.String = 'delay (sec)';

% Create rectangle
annotation(figure1,'rectangle', [0.654 0.780 0.0704 0.097],'Color',[1 1 0.066],'FaceColor',[0.501 0.501 0.501]);
annotation(figure1,'rectangle',[0.6545 0.1571 0.07042 0.09761],'Color',[1 1 0.06666],'FaceColor',[0.501 0.501 0.501]);
annotation(figure1,'rectangle',[0.186 0.1595 0.0704 0.0976],'Color',[1 1 0.06666],'FaceColor',[0.5019607 0.5019607 0.50196]);
annotation(figure1,'rectangle', [0.186714 0.7809 0.07042 0.0976],'Color',[1 1 0.0666],'FaceColor',[0.50196 0.5019 0.501960]);
annotation(figure1,'rectangle',[0.18671 0.4261 0.070428 0.097],'Color',[1 1 0.0666],'FaceColor',[0.501960 0.50196 0.501960]);

















